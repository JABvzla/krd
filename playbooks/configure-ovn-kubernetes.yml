---
# SPDX-license-identifier: Apache-2.0
##############################################################################
# Copyright (c) 2018
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################
- hosts: all
  vars:
    central_node_ip: "{{ hostvars[groups['ovn-central'][0]]['ansible_ssh_host'] }}"
  environment:
    PATH: "{{ ansible_env.PATH }}:/usr/local/go/bin/"
  roles:
    - role: andrewrothstein.go
  tasks:
    - name: clone ovn-kubernetes repository
      git:
        repo: http://github.com/openvswitch/ovn-kubernetes
        dest: "/tmp/ovn-kubernetes"
    - name: make ovnkube files
      make:
        chdir: "/tmp/ovn-kubernetes/go-controller"
    - name: install ovnkube files
      make:
        chdir: "/tmp/ovn-kubernetes/go-controller"
        target: install
      become: yes
    - name: create OVN Kubernetes config file
      become: yes
      blockinfile:
        path: /etc/openvswitch/ovn_k8s.conf
        create: yes
        block: |
          [logging]
          loglevel=4
          logfile=/var/log/openvswitch/ovnkube.log
    - name: create ovnkube logging directory
      file:
        path: /var/log/openvswitch
        state: directory

- hosts: kube-node
  tasks:
    - name: copy k8s admin.conf file
      become: yes
      copy:
        src: /root/.kube/config
        dest: /etc/kubernetes/admin.conf

- hosts: ovn-controller
  become: yes
  vars:
    central_node_ip: "{{ hostvars[groups['ovn-central'][0]]['ansible_ssh_host'] }}"
  tasks:
    - name: create ovnkube controller systemd service
      blockinfile:
        path: /etc/systemd/system/ovn-k8s-host.service
        create: yes
        block: |
          [Unit]
          Description=OVN Controller Daemon

          [Service]
          ExecStart=/usr/bin/ovnkube -init-node="{{ ansible_hostname }}" -nodeport -nb-address="tcp://{{ central_node_ip }}:6641" -sb-address="tcp://{{ central_node_ip }}:6642" -init-gateways -service-cluster-ip-range=172.16.1.0/24 -cluster-subnet="192.168.0.0/16" -k8s-kubeconfig=/etc/kubernetes/admin.conf -k8s-token="test"

          [Install]
          WantedBy=multi-user.target
    - name: start ovnkube controller systemd service
      service:
        name: ovn-k8s-host
        state: started
        enabled: yes

- hosts: ovn-central
  become: yes
  tasks:
    - name: create ovnkube central systemd service
      blockinfile:
        path: /etc/systemd/system/ovn-k8s-central.service
        create: yes
        block: |
          [Unit]
          Description=OVN Central Daemon

          [Service]
          ExecStart=/usr/bin/ovnkube -net-controller -init-master="{{ ansible_hostname }}" -cluster-subnet="192.168.0.0/16" -init-node="{{ ansible_hostname }}" -service-cluster-ip-range=172.16.1.0/24 -nodeport -k8s-kubeconfig=/etc/kubernetes/admin.conf -k8s-token="test"

          [Install]
          WantedBy=multi-user.target
    - name: start ovnkube central systemd service
      service:
        name: ovn-k8s-central
        state: started
        enabled: yes
